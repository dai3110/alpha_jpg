window.AlphaJpgApp = window.AlphaJpgApp || {};(function(){	var clearCanvas = function(imageResultArea, mainCanvas, maskCanvas){		if(!!mainCanvas.width && !!mainCanvas.height){			mainCanvas.getContext("2d").clearRect(0, 0, mainCanvas.width, mainCanvas.height);		}		if(!!maskCanvas.width && !!maskCanvas.height){			maskCanvas.getContext("2d").clearRect(0, 0, maskCanvas.width, maskCanvas.height);		}				var resultImages = imageResultArea.querySelectorAll("IMG");		for(var i=0; i<resultImages.length; i++){			resultImages[i].parentNode.removeChild(resultImages[i]);		}	};		var confirmImage = function(elements){		var file = elements.imageInput.files[0];		var reader = new FileReader();		reader.onloadend = function(){			elements.confirmImage.parentNode.parentNode.classList.remove("noimage");			elements.confirmImage.src = reader.result;		}		if(!!file){			reader.readAsDataURL(file);			clearCanvas(elements.imageResults, elements.mainCanvas, elements.maskCanvas);			currentFileName = file.name;						elements.filesizeInfo.innerHTML = file.size + "byte";		}		else{			elements.confirmImage.src = "";			elements.confirmImage.parentNode.parentNode.classList.add("noimage");			clearCanvas(elements.imageResults, elements.mainCanvas, elements.maskCanvas);		}	};		var canvas2jpg = function(canvas, jpgLevel){		var dataurl = canvas.toDataURL("image/jpeg", jpgLevel);		var bin = atob(dataurl.split(",")[1]);		var buffer = new Uint8Array(bin.length);		for(var i=0; i<bin.length; i++){			buffer[i] = bin.charCodeAt(i);		}		return buffer;	};		var conv2jpg = function(elements){		var jpgLevel = Math.min(1, Math.max(0, elements.jpgLebelInput.value / 100));		var src = elements.confirmImage.getAttribute("src");		var canvases = {			main : elements.mainCanvas,			mask : elements.maskCanvas		};		clearCanvas(elements.imageResults, elements.mainCanvas, elements.maskCanvas);				for(var type in canvases){			(function(canvas){				var con = canvas.getContext("2d");				canvas.setAttribute("width", elements.confirmImage.naturalWidth);				canvas.setAttribute("height", elements.confirmImage.naturalHeight);				con.drawImage(elements.confirmImage, 0, 0);			})(canvases[type]);		}				var mainCon = canvases.main.getContext("2d");		var mainImageData = mainCon.getImageData(0, 0, elements.confirmImage.naturalWidth, elements.confirmImage.naturalHeight);		for(var i=0; i<mainImageData.data.length; i+=4){			(function(pos){				mainImageData.data[pos + 3] = 255;			})(i);		}		mainCon.putImageData(mainImageData, 0, 0);		var maskCon = canvases.mask.getContext("2d");		var maskImageData = maskCon.getImageData(0, 0, elements.confirmImage.naturalWidth, elements.confirmImage.naturalHeight);		for(var i=0; i<maskImageData.data.length; i+=4){			(function(pos){				maskImageData.data[pos + 0] = maskImageData.data[pos + 3];				maskImageData.data[pos + 1] = maskImageData.data[pos + 3];				maskImageData.data[pos + 2] = maskImageData.data[pos + 3];				maskImageData.data[pos + 3] = 255;							})(i);		}		maskCon.putImageData(maskImageData, 0, 0);		AlphaJpgApp.toZipFile(canvas2jpg(canvases.main, jpgLevel), canvas2jpg(canvases.mask, jpgLevel));	};	AlphaJpgApp.setup = function(elements){		elements.imageInput.addEventListener("change", function(){			confirmImage(elements);		}, false);				elements.createTrigger.addEventListener("click", function(){			conv2jpg(elements);		}, false);	};})();